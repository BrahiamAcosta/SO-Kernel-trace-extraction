CXX = g++
CXXFLAGS = -std=c++17 -O3 -Wall -pthread -D_GLIBCXX_USE_CXX11_ABI=1
TARGET_PREDICTOR = ml_predictor
TARGET_EBPF = ebpf_block_trace

LIBTORCH_PATH = $(HOME)/kml-project/libtorch
BCC_PATH = /usr

# LLVM version
LLVM_VERSION = 14
LLVM_LIB_PATH = /usr/lib/llvm-$(LLVM_VERSION)/lib
LLVM_INCLUDE_PATH = /usr/lib/llvm-$(LLVM_VERSION)/include

# Includes para ml_predictor (libtorch)
INCLUDES_TORCH = -I$(LIBTORCH_PATH)/include \
                 -I$(LIBTORCH_PATH)/include/torch/csrc/api/include

# Includes para ebpf_block_trace (BCC + LLVM)
INCLUDES_BCC = -I$(BCC_PATH)/include/bcc \
               -I$(LLVM_INCLUDE_PATH)

# Libs para ml_predictor
LIBS_TORCH = -L$(LIBTORCH_PATH)/lib \
             -ltorch \
             -ltorch_cpu \
             -lc10 \
             -ltorch_global_deps \
             -lkineto

# Libs para ebpf_block_trace (BCC + LLVM)
LIBS_BCC = -L$(LLVM_LIB_PATH) \
           -lbcc \
           -lclang \
           -lLLVM

LDFLAGS_TORCH = -Wl,-rpath,$(LIBTORCH_PATH)/lib

all: $(TARGET_PREDICTOR) $(TARGET_EBPF)

$(TARGET_PREDICTOR): ml_predictor.cpp
	@echo "Compilando daemon ML predictor (C++)..."
	$(CXX) $(CXXFLAGS) $(INCLUDES_TORCH) ml_predictor.cpp -o $(TARGET_PREDICTOR) $(LIBS_TORCH) $(LDFLAGS_TORCH)
	@echo "✓ Compilación exitosa: $(TARGET_PREDICTOR)"

$(TARGET_EBPF): ebpf_block_trace.cpp
	@echo "Compilando eBPF block trace collector (C++)..."
	$(CXX) $(CXXFLAGS) $(INCLUDES_BCC) ebpf_block_trace.cpp -o $(TARGET_EBPF) $(LIBS_BCC)
	@echo "✓ Compilación exitosa: $(TARGET_EBPF)"

clean:
	rm -f $(TARGET_PREDICTOR) $(TARGET_EBPF)
